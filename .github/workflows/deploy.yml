name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Backend Testing & Build
  backend:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'
    
    - name: Restore
      run: dotnet restore backend/
    
    - name: Build
      run: dotnet build backend/ --configuration Release --no-restore
    
    - name: Run Tests
      run: dotnet test backend/ --configuration Release --no-build
    
    - name: Publish
      run: dotnet publish backend/ -c Release -o backend/publish
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v3
      with:
        name: backend-build
        path: backend/publish

  # Frontend Testing & Build
  frontend:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install Dependencies
      run: npm ci
      working-directory: frontend
    
    - name: Lint
      run: npm run lint
      working-directory: frontend
      continue-on-error: true
    
    - name: Build
      run: npm run build
      working-directory: frontend
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v3
      with:
        name: frontend-build
        path: frontend/dist

  # Mobile Build
  mobile:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.x'
        channel: 'stable'
    
    - name: Get dependencies
      run: flutter pub get
      working-directory: mobile
    
    - name: Analyze
      run: flutter analyze
      working-directory: mobile
      continue-on-error: true
    
    - name: Build APK
      run: flutter build apk --release
      working-directory: mobile

  # Deploy to Staging
  deploy-staging:
    needs: [backend, frontend, mobile]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Download Backend Artifact
      uses: actions/download-artifact@v3
      with:
        name: backend-build
        path: backend/publish
    
    - name: Download Frontend Artifact
      uses: actions/download-artifact@v3
      with:
        name: frontend-build
        path: frontend/dist
    
    - name: Deploy to Azure (Staging)
      uses: azure/webapps-deploy@v2
      with:
        app-name: 'badnews-api-staging'
        publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE_STAGING }}
        package: backend/publish

  # Deploy to Production
  deploy-production:
    needs: [backend, frontend, mobile]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://badnews.mx
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Download Backend Artifact
      uses: actions/download-artifact@v3
      with:
        name: backend-build
        path: backend/publish
    
    - name: Download Frontend Artifact
      uses: actions/download-artifact@v3
      with:
        name: frontend-build
        path: frontend/dist
    
    - name: Deploy Backend to Azure
      uses: azure/webapps-deploy@v2
      with:
        app-name: 'badnews-api'
        publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE }}
        package: backend/publish
    
    - name: Deploy Frontend
      uses: actions/deploy-pages@v2
      with:
        artifact_name: frontend-build
        path: frontend/dist
    
    - name: Notify Slack
      uses: slackapi/slack-github-action@v1.24.0
      with:
        payload: |
          {
            "text": "Production deployment completed successfully",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "âœ… *BadNews Production Deployed*\nVersion: ${{ github.sha }}\nAuthor: ${{ github.actor }}"
                }
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
      continue-on-error: true
