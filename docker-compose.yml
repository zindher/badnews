version: '3.8'

services:
  # SQL Server Database
  mssql:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: badnews-mssql
    ports:
      - "1433:1433"
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "BadNews@2024Dev"
      MSSQL_PID: "Express"
    volumes:
      - sqlserver_data:/var/opt/mssql
    healthcheck:
      test: ["CMD", "/opt/mssql-tools/bin/sqlcmd", "-S", "localhost", "-U", "sa", "-P", "BadNews@2024Dev", "-Q", "SELECT 1"]
      interval: 10s
      timeout: 3s
      retries: 10

  # Backend API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: badnews-api
    ports:
      - "5000:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=Server=mssql;Database=BadNews;User Id=sa;Password=BadNews@2024Dev;TrustServerCertificate=true;
      - Twilio__AccountSid=${TWILIO_ACCOUNT_SID}
      - Twilio__AuthToken=${TWILIO_AUTH_TOKEN}
      - Twilio__PhoneNumber=${TWILIO_PHONE_NUMBER}
      - MercadoPago__AccessToken=${MERCADO_PAGO_ACCESS_TOKEN}
      - SendGrid__ApiKey=${SENDGRID_API_KEY}
      - Jwt__Secret=${JWT_SECRET}
    depends_on:
      mssql:
        condition: service_healthy
    volumes:
      - ./backend:/app
    networks:
      - badnews-network

  # Frontend (opcional - normalmente se ejecuta con npm)
  frontend:
    image: node:18-alpine
    container_name: badnews-frontend
    ports:
      - "5173:5173"
    working_dir: /app
    command: sh -c "npm install && npm run dev"
    environment:
      - VITE_API_BASE_URL=http://localhost:5000
    volumes:
      - ./frontend:/app
    depends_on:
      - backend
    networks:
      - badnews-network

volumes:
  sqlserver_data:

networks:
  badnews-network:
    driver: bridge
